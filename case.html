<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Investigation - Case011</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Special+Elite&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
</head>

<body class="case-page">
    <div class="grain-overlay"></div>
    <div id="decryptionOverlay" class="decryption-overlay">
        <div class="decryption-content">
            <h2 class="decryption-header glitch-text">OSINT LIVE SCANNING...</h2>
            <div id="aiStatusText" class="decryption-status">ESTABLISHING GLOBAL ARCHIVAL LINK...</div>
            <div class="decryption-bar-container">
                <div id="aiProgressBar" class="decryption-bar" style="width: 100%; transition: width 0.5s ease;"></div>
            </div>
            <div class="decryption-meta">
                <span>INTERCEPTING...</span>
                <span>SECURE KNOWLEDGE STREAM</span>
            </div>
            <p
                style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 2rem; border-top: 1px dashed var(--color-border); padding-top: 1rem;">
                * Warning: Direct archival interception in progress. Zero API keys intercepted.
            </p>
        </div>
    </div>

    <header class="case-header">
        <div class="header-content">
            <a href="index.html" class="back-link">&#8592; Back to Home</a>
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="assets/logo.png" alt="Logo" class="header-logo">
                <h1 class="case-title">CASE011</h1>
            </div>
            <div class="case-meta">
                <span class="case-hash" id="caseHashDisplay"></span>
                <button class="share-btn" id="shareBtn" title="Share this case">&#10697;</button>
            </div>
        </div>
    </header>

    <main class="case-container">
        <div class="case-layout">
            <!-- Case Briefing Section -->
            <section class="case-briefing">
                <div class="section-header">
                    <h2 class="section-title">CASE BRIEFING</h2>
                    <span class="classification-label">CLASSIFIED</span>
                </div>
                <div class="briefing-content">
                    <h3 class="case-name" id="caseName">DECRYPTING...</h3>
                    <div class="case-details">
                        <span class="detail-item">Category: <strong id="caseCategory"></strong></span>
                        <span class="detail-item">Difficulty: <strong id="caseDifficulty"></strong><span
                                id="difficultyBadge"></span></span>
                        <span class="detail-item">Date Opened: <strong id="dateOpened"></strong></span>
                    </div>
                    <div class="briefing-text" id="briefingText">
                        <p>Awaiting analytical reconstruction...</p>
                    </div>
                </div>
            </section>

            <!-- Progress Tracker -->
            <section class="progress-tracker" id="progressTracker">
                <div class="progress-header">
                    <span class="progress-title">INVESTIGATION PROGRESS</span>
                    <span class="progress-percentage" id="progressText">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-achievements" id="achievementsList"></div>
            </section>

            <!-- Signal Strength Indicator -->
            <section class="signal-strength-container" id="signalStrengthContainer">
                <div class="signal-strength-header">
                    <span class="signal-strength-title">SOLUTION PROXIMITY</span>
                    <div id="signalStrength">
                        <div class="signal-bars">
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                            <div class="signal-bar"></div>
                        </div>
                        <div class="signal-percentage">0%</div>
                        <div class="signal-hint">SIGNAL WEAK - BEGIN RESEARCH INTO CORE EVIDENCE</div>
                    </div>
                </div>
            </section>

            <!-- Artifacts Section -->
            <section class="artifacts-section">
                <div class="section-header">
                    <h2 class="section-title">EVIDENCE & ARTIFACTS</h2>
                    <span class="artifact-count" id="artifactCount">0 items</span>
                </div>
                <div class="artifacts-grid" id="artifactsGrid">
                    <!-- Artifacts will be loaded here -->
                </div>
            </section>

            <!-- Notebook Section -->
            <section class="notebook-section">
                <div class="section-header">
                    <h2 class="section-title">INVESTIGATION NOTEBOOK</h2>
                    <div class="investigation-timer">
                        <span class="timer-label">TIME:</span>
                        <span class="timer-display" id="timerDisplay">00:00:00</span>
                    </div>
                    <div class="notebook-controls">
                        <button class="icon-btn" id="timestampBtn" title="Insert timestamp">&#128337;</button>
                        <button class="icon-btn" id="clearBtn" title="Clear notebook">&#128465;</button>
                        <button class="icon-btn export-pdf-btn" id="exportPdfBtn" title="Export as PDF"
                            onclick="window.print()">&#128438; PDF</button>
                        <span class="save-indicator" id="saveIndicator">Auto-saved</span>
                    </div>
                </div>
                <div class="notebook-container">
                    <textarea class="notebook-textarea" id="notebookArea" placeholder="Begin your investigation notes here...

Document your findings, theories, and observations.
Reference artifacts by number.
Build your case step by step.

The truth is in the details."></textarea>
                    <div class="notebook-stats">
                        <span id="wordCount">0 words</span>
                        <span id="charCount">0 characters</span>
                    </div>
                </div>
            </section>

            <!-- Submit Section -->
            <section class="submit-section">
                <button type="button" class="primary-btn submit-btn" id="submitBtn">
                    <span class="btn-icon">&#10004;</span>
                    <span class="btn-text">SUBMIT INVESTIGATION</span>
                </button>
                <p class="submit-note">Your investigation will be added to the community archive</p>
            </section>
        </div>
    </main>

    <footer class="footer-review-section">
        <div class="landing-footer" style="margin-top: 0;">
            <nav class="footer-nav">
                <a href="index.html" class="footer-link">Home</a>
                <a href="archive.html" class="footer-link">Archive</a>
                <a href="mysteries.html" class="footer-link">Catalog</a>
                <a href="index.html#rules" class="footer-link">Rules</a>
                <a href="index.html#disclaimer" class="footer-link">Disclaimer</a>
            </nav>
            <p class="footer-text">CASE011 - Archives of the Unexplained</p>
        </div>
    </footer>

    <!-- Ambience Control Panel -->
    <div class="ambience-control" id="ambienceControl">
        <div class="ambience-header">
            <span class="ambience-title">ATMOSPHERE</span>
            <button class="ambience-toggle" id="ambienceToggle">&#9660;</button>
        </div>
        <div class="ambience-body" id="ambienceBody">
            <div class="ambience-modes">
                <button class="ambience-mode-btn" data-mode="silent">Silent</button>
                <button class="ambience-mode-btn" data-mode="terminal">Terminal Hum</button>
                <button class="ambience-mode-btn" data-mode="rain">Rain on Window</button>
                <button class="ambience-mode-btn" data-mode="radio">Vintage Radio</button>
            </div>
            <div class="ambience-volume">
                <span class="ambience-volume-label">Volume:</span>
                <input type="range" class="ambience-volume-slider" id="volumeSlider" min="0" max="100" value="30">
            </div>
        </div>
    </div>

    <!-- Theme Switcher -->
    <div class="theme-switcher" id="themeSwitcher">
        <div class="theme-switcher-title">THEME</div>
        <div class="theme-buttons">
            <button class="theme-btn active" data-theme="dark">Dark</button>
            <button class="theme-btn" data-theme="crt">CRT</button>
            <button class="theme-btn" data-theme="light">Light</button>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/caseGenerator.js"></script>
    <script src="js/aiGenerator.js"></script>
    <script src="js/notebook.js"></script>
    <script src="js/ambience.js"></script>
    <script src="js/progressTracker.js"></script>
    <script src="js/secretDetector.js"></script>
    <script src="js/caseAge.js"></script>
    <script src="js/signalStrength.js"></script>
    <script src="js/smartHighlight.js"></script>
    <script src="js/themeSwitcher.js"></script>
    <script src="js/investigationTimer.js"></script>
    <script src="js/featureInit.js"></script>
    <script>
        // Initialize case page
        const urlParams = new URLSearchParams(window.location.search);
        const caseHash = urlParams.get('hash');

        // Oracle Engine is default unless explicitly disabled
        const useAI = urlParams.get('ai') !== 'false';

        if (!caseHash) {
            console.error('No case hash provided. Redirecting...');
            document.body.innerHTML = '<div style="color: var(--color-text); padding: 2rem; font-family: var(--font-display); text-align: center;"><h2>Error: No Case Hash Provided</h2><p>Returning to home page...</p></div>';
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        } else {
            // Display case hash
            const hashDisplay = document.getElementById('caseHashDisplay');
            if (hashDisplay) hashDisplay.textContent = `#${caseHash}`;

            // Helper to populate UI with case data
            function renderCaseData(caseData) {
                if (!caseData) return;

                // Content population
                const elements = {
                    name: document.getElementById('caseName'),
                    category: document.getElementById('caseCategory'),
                    difficulty: document.getElementById('caseDifficulty'),
                    date: document.getElementById('dateOpened'),
                    briefing: document.getElementById('briefingText'),
                    wiki: document.getElementById('wikiLinkContainer'),
                    artifacts: document.getElementById('artifactsGrid'),
                    count: document.getElementById('artifactCount')
                };

                if (elements.name) elements.name.textContent = caseData.title;
                if (elements.category) elements.category.textContent = (caseData.category || 'Unknown').toUpperCase();
                if (elements.difficulty) {
                    const difficulty = caseData.difficulty || 'Normal';
                    elements.difficulty.textContent = difficulty.toUpperCase();

                    // Add difficulty badge
                    const badgeElement = document.getElementById('difficultyBadge');
                    if (badgeElement) {
                        const badgeClass = difficulty.toLowerCase() === 'easy' ? 'difficulty-easy' :
                            difficulty.toLowerCase() === 'hard' ? 'difficulty-hard' : 'difficulty-medium';
                        badgeElement.innerHTML = `<span class="difficulty-badge ${badgeClass}">${difficulty.toUpperCase()}</span>`;
                    }
                }
                if (elements.date) elements.date.textContent = formatDate(new Date());

                // Set briefing and add preview image if exists
                if (elements.briefing) {
                    let briefingHTML = caseData.briefing;
                    if (caseData.image) {
                        briefingHTML = `
                            <div class="case-preview-image">
                                <img src="${caseData.image}" alt="Archival Preview" onerror="this.parentElement.style.display='none'">
                                <div class="image-label">ARCHIVAL PHOTOGRAPHIC RECORD - UNKNOWN DATE</div>
                            </div>
                        ` + briefingHTML;
                    }
                    elements.briefing.innerHTML = briefingHTML;
                }

                // Add Wikipedia Link to the metadata or footer
                if (caseData.wikipedia) {
                    const wikiBtnHTML = `
                        <div class="wiki-link-container" style="margin-top: 2rem; border-top: 1px dashed var(--color-border); padding-top: 1.5rem;">
                            <a href="${caseData.wikipedia}" target="_blank" class="primary-btn wiki-btn" style="background: rgba(255, 191, 0, 0.1); border: 1px solid var(--color-accent-amber); color: var(--color-accent-amber); text-decoration: none; display: inline-flex; align-items: center; gap: 10px; font-size: 0.8rem; letter-spacing: 1px;">
                                <span style="font-size: 1.2rem;">&#128214;</span> ACCESS PRIMARY ARCHIVAL SOURCE
                            </a>
                        </div>
                    `;
                    if (elements.briefing) elements.briefing.innerHTML += wikiBtnHTML;
                }

                if (elements.count) elements.count.textContent = `${(caseData.artifacts || []).length} items`;

                if (elements.artifacts) {
                    elements.artifacts.innerHTML = '';
                    (caseData.artifacts || []).forEach((artifact, index) => {
                        const artifactCard = document.createElement('div');
                        artifactCard.className = 'artifact-card';
                        artifactCard.innerHTML = `
                            <div class="artifact-header">
                                <span class="artifact-number">ARTIFACT ${String(index + 1).padStart(2, '0')}</span>
                                <span class="artifact-type">${(artifact.type || 'EVIDENCE').toUpperCase()}</span>
                            </div>
                            <h4 class="artifact-title">${artifact.title}</h4>
                            <p class="artifact-desc">${artifact.description || ''}</p>
                            <a href="${artifact.url}" target="_blank" class="artifact-link" rel="noopener noreferrer">
                                View Evidence &#8599;
                            </a>`;
                        elements.artifacts.appendChild(artifactCard);
                    });
                }
            }

            // Load case data
            async function loadCase() {
                const overlay = document.getElementById('decryptionOverlay');
                const briefingElement = document.getElementById('briefingText');
                const statusText = document.getElementById('aiStatusText');
                let caseData;

                try {
                    if (overlay) overlay.style.display = 'flex';
                    if (statusText) statusText.textContent = 'INITIATING LIVE OSINT SCAN...';

                    if (useAI) {
                        if (briefingElement) briefingElement.innerHTML = '<p style="color: var(--color-accent-cyan); text-align: center; margin-top: 2rem;">STANDBY: Intercepting signal from Global Knowledge Repositories...</p>';
                        caseData = await generateCaseWithAI(caseHash, true);
                    } else {
                        caseData = generateCase(caseHash);
                    }

                    if (!caseData) throw new Error('Data reconstruction failed');
                    renderCaseData(caseData);

                    // Success: Hide overlay
                    setTimeout(() => {
                        if (overlay) {
                            overlay.classList.add('hidden');
                            setTimeout(() => overlay.style.display = 'none', 1000);
                        }
                    }, 800);

                } catch (error) {
                    console.error('Case loading failed:', error);
                    if (statusText) {
                        statusText.textContent = 'OSINT ERROR: Reverting to local archives...';
                        statusText.style.color = 'var(--color-accent-red)';
                    }

                    caseData = generateCase(caseHash);
                    renderCaseData(caseData);

                    setTimeout(() => {
                        if (overlay) {
                            overlay.classList.add('hidden');
                            setTimeout(() => overlay.style.display = 'none', 1000);
                        }
                    }, 2000);
                }
            }

            loadCase();
            initNotebook(caseHash);

            // Initialize Progress Tracker
            let progressTracker, secretDetector;
            let caseData = null;

            async function initializeFeatures() {
                // Wait for case data to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Get case data from the page
                const caseName = document.getElementById('caseName')?.textContent;
                const caseId = getCaseIdFromTitle(caseName);

                // Initialize progress tracker
                progressTracker = new ProgressTracker(caseHash);
                progressTracker.startTracking();
                window.progressTracker = progressTracker;

                // Initialize secret detector
                if (caseId) {
                    secretDetector = new SecretDetector(caseId, caseHash);
                    const notebookArea = document.getElementById('notebookArea');
                    if (notebookArea) {
                        secretDetector.startMonitoring(notebookArea);
                    }
                }

                // Hook into notebook updates for progress tracking
                const notebookArea = document.getElementById('notebookArea');
                if (notebookArea && progressTracker) {
                    notebookArea.addEventListener('input', () => {
                        const wordCount = countWords(notebookArea.value);
                        progressTracker.updateWordCount(wordCount);
                    });
                }

                // Track artifact views
                document.querySelectorAll('.artifact-link').forEach((link, index) => {
                    link.addEventListener('click', () => {
                        if (progressTracker) {
                            progressTracker.markArtifactViewed(`artifact-${index}`);
                        }
                    });
                });

                // Override timestamp button to track
                const originalTimestampBtn = document.getElementById('timestampBtn');
                if (originalTimestampBtn && progressTracker) {
                    originalTimestampBtn.addEventListener('click', () => {
                        progressTracker.incrementTimestamps();
                    });
                }

                // Initialize Case Age Tracker
                const caseAgeTracker = new CaseAgeTracker(caseHash);
                caseAgeTracker.applyCaseAgeStyles();

                // Initialize Signal Strength Indicator
                if (caseId) {
                    const signalStrength = new SignalStrengthIndicator(caseId, caseHash);
                    const notebookArea = document.getElementById('notebookArea');
                    if (notebookArea) {
                        signalStrength.startMonitoring(notebookArea);
                    }
                }

                // Initialize Smart Highlighter
                const smartHighlighter = new SmartHighlighter();
                const notebookArea2 = document.getElementById('notebookArea');
                if (notebookArea2) {
                    smartHighlighter.startMonitoring(notebookArea2);
                }

                // Initialize Investigation Timer
                const investigationTimer = new InvestigationTimer(caseHash);
                investigationTimer.start();
                window.investigationTimer = investigationTimer;
            }

            initializeFeatures();

            // Initialize Ambience Controls
            const ambienceController = getAmbienceController();
            const ambienceToggle = document.getElementById('ambienceToggle');
            const ambienceBody = document.getElementById('ambienceBody');
            const ambienceControl = document.getElementById('ambienceControl');
            const volumeSlider = document.getElementById('volumeSlider');

            // Collapse/expand ambience panel
            let isCollapsed = false;
            ambienceToggle.addEventListener('click', () => {
                isCollapsed = !isCollapsed;
                if (isCollapsed) {
                    ambienceBody.style.display = 'none';
                    ambienceToggle.innerHTML = '&#9650;';
                } else {
                    ambienceBody.style.display = 'block';
                    ambienceToggle.innerHTML = '&#9660;';
                }
            });

            // Ambience mode buttons
            document.querySelectorAll('.ambience-mode-btn').forEach(btn => {
                const mode = btn.dataset.mode;

                // Set active state based on saved preference
                if (ambienceController.getCurrentMode() === mode) {
                    btn.classList.add('active');
                }

                btn.addEventListener('click', () => {
                    // Remove active from all buttons
                    document.querySelectorAll('.ambience-mode-btn').forEach(b => b.classList.remove('active'));

                    // Add active to clicked button
                    btn.classList.add('active');

                    // Play the selected mode
                    ambienceController.playMode(mode);
                });
            });

            // Volume control
            volumeSlider.value = ambienceController.getVolume() * 100;
            volumeSlider.addEventListener('input', (e) => {
                const volume = e.target.value / 100;
                ambienceController.setVolume(volume);
            });

            // Auto-play saved mode on load
            setTimeout(() => {
                const savedMode = ambienceController.getCurrentMode();
                if (savedMode && savedMode !== 'silent') {
                    ambienceController.playMode(savedMode);
                }
            }, 1000);

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (progressTracker) {
                    progressTracker.stopTracking();
                }
                if (secretDetector) {
                    secretDetector.stopMonitoring();
                }
                if (ambienceController) {
                    ambienceController.stop();
                }
            });

            document.getElementById('shareBtn').addEventListener('click', () => {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Case link copied to clipboard!');
                });
            });

            document.getElementById('submitBtn').addEventListener('click', () => {
                const notebook = document.getElementById('notebookArea').value;
                if (notebook.trim().length < 100) {
                    alert('Please write at least 100 characters in your investigation notes before submitting.');
                    return;
                }

                // Save active case data for the submission page
                if (caseData) {
                    sessionStorage.setItem('activeCaseData', JSON.stringify(caseData));
                }

                window.location.href = `submit.html?hash=${caseHash}`;
            });
        }
    </script>
</body>

</html>